import { Injectable, signal } from '@angular/core';

export const SUPPORTED_LOCALES = ['en', 'ru', 'tj'] as const;
export type Locale = (typeof SUPPORTED_LOCALES)[number];

const STORAGE_KEY = 'user-page.locale.v1';

const EN_MESSAGES = {
  'action.ask_ai_tutor': 'Ask AI Tutor',
  'action.change': 'Change',
  'action.copy': 'Copy',
  'action.choose_format': 'Choose format',
  'action.continue': 'Continue',
  'action.delete': 'Delete',
  'action.download': 'Download',
  'action.forgot_password': 'Forgot password?',
  'action.my_courses': 'My courses',
  'action.new_chat': 'New chat',
  'action.new_note': 'New note',
  'action.open_notebook': 'Open Notebook',
  'action.open_lessons': 'Lessons',
  'action.open_quizzes': 'Quizzes',
  'action.open_tests': 'Tests',
  'action.remove': 'Remove',
  'action.review': 'Review',
  'action.save': 'Save',
  'action.save_changes': 'Save changes',
  'action.send': 'Send',
  'action.sign_in': 'Sign in',
  'action.sign_out': 'Sign out',
  'action.show_password': 'Show password',
  'action.hide_password': 'Hide password',
  'action.start': 'Start',
  'action.start_practice': 'Start practice',
  'action.submit_demo': 'Submit demo',
  'action.switch_to_b2b': 'Switch to B2B Tenant',
  'action.update_password': 'Update password',
  'action.use_saved_domain': 'Use saved domain',
  'action.use_test_account': 'Use test account',
  'action.view_all': 'View all',
  'action.view_result': 'View result',
  'app.tagline': 'Student portal',
  'dashboard.courses_in_progress': 'Courses in progress',
  'dashboard.lessons_completed': 'Lessons completed',
  'dashboard.next_up': 'Next up',
  'error.invalid_credentials': 'Invalid email or password',
  'error.network': 'Network error. Check your connection.',
  'error.sign_in_failed': 'Sign-in failed',
  'header.search_placeholder': 'Search courses, lessons...',
  'heading.ai_tutor': 'AI Tutor',
  'heading.change_password': 'Change password',
  'heading.company_domain': 'Company domain',
  'heading.courses': 'Courses',
  'heading.dashboard': 'Dashboard',
  'heading.dida': 'Dida Method',
  'heading.downloads': 'Downloads',
  'heading.lesson_materials': 'Lesson materials',
  'heading.login_request_http': 'Login request over HTTP',
  'heading.lessons': 'Lessons',
  'heading.notebook': 'Think Note',
  'heading.profile': 'Profile',
  'heading.quizzes': 'Quizzes',
  'heading.security': 'Security',
  'heading.session': 'Session',
  'heading.student_profile': 'Student profile',
  'heading.tests': 'Tests',
  'heading.user': 'User',
  'label.bio': 'Bio',
  'label.company_domain': 'Company domain',
  'label.code': 'Code',
  'label.confirm_new_password': 'Confirm new password',
  'label.content': 'Content',
  'label.course': 'Course',
  'label.current_password': 'Current password',
  'label.date': 'Date',
  'label.date_of_birth': 'Date of birth',
  'label.domain': 'Domain',
  'label.duration': 'Duration',
  'label.email': 'Email',
  'label.example': 'Example',
  'label.http': 'HTTP',
  'label.json': 'JSON',
  'label.request': 'Request',
  'label.url': 'URL',
  'label.enrollment_date': 'Enrollment date',
  'label.first_name': 'First name',
  'label.gender': 'Gender',
  'gender.female': 'Female',
  'gender.male': 'Male',
  'gender.other': 'Other',
  'label.grade_level': 'Grade level',
  'label.language': 'Language',
  'label.language_preference': 'Language preference',
  'label.last_name': 'Last name',
  'label.lesson': 'Lesson',
  'label.notes': 'Notes',
  'label.offline': 'Offline',
  'label.online_copy': 'Online copy',
  'label.parent_guardian_name': 'Parent/guardian name',
  'label.parent_guardian_phone': 'Parent/guardian phone',
  'label.password': 'Password',
  'label.new_password': 'New password',
  'label.phone': 'Phone',
  'label.position_title': 'Position title',
  'label.preferred_time': 'Preferred time',
  'label.profile_photo': 'Profile photo',
  'label.questions': 'Questions',
  'label.quiz': 'Quiz',
  'label.score': 'Score',
  'label.status': 'Status',
  'label.title': 'Title',
  'label.tutor': 'Tutor',
  'label.you': 'You',
  'message.ai_tutor_intro': 'Ask questions and get practice (demo, no backend).',
  'message.all_caught_up': 'All caught up',
  'message.b2b_only_courses': 'Courses are available only for B2B Tenant right now.',
  'message.b2b_only_dashboard': 'Learning dashboard is available only for B2B Tenant right now.',
  'message.b2b_only_downloads': 'Downloads are available only for B2B Tenant right now.',
  'message.b2b_only_lessons': 'Lessons are available only for B2B Tenant right now.',
  'message.b2b_only_quizzes': 'Quizzes are available only for B2B Tenant right now.',
  'message.b2b_only_tests': 'Tests are available only for B2B Tenant right now.',
  'message.coming_soon': 'Coming soon',
  'message.courses_intro': 'Open a course to view lessons, quizzes, and tests.',
  'message.dashboard_continue': 'Continue learning from where you left off.',
  'message.dida_intro': 'Short focused practice with feedback.',
  'message.domain_intro': 'Enter your company name to continue to your portal.',
  'message.downloads_intro': 'Lesson files (PDF, DOCX, ZIP, MP3, MP4).',
  'message.great_work': 'Great work!',
  'message.lesson_materials_intro':
    'Teachers add files after class. Video/audio become available when the online copy is published.',
  'message.lessons_intro': 'Offline schedule with online copies after class.',
  'message.loading_courses': 'Loading courses...',
  'message.loading_dashboard': 'Loading dashboard...',
  'message.loading_downloads': 'Loading downloads...',
  'message.loading_lessons': 'Loading lessons...',
  'message.loading_quizzes': 'Loading quizzes...',
  'message.loading_tests': 'Loading tests...',
  'message.login_intro':
    'Login to access courses, lessons, quizzes, tests, downloads, notebook and AI tutor. Accounts are provisioned by administrators.',
  'message.no_course_selected': 'No course selected',
  'message.no_courses': 'No courses yet',
  'message.no_files': 'No files yet - coming soon.',
  'message.no_note_selected': 'No note selected',
  'message.notebook_intro': 'Save ideas, answers, and questions for later.',
  'message.practice_step_1': 'Pick one skill',
  'message.practice_step_2': 'Practice 10-15 minutes',
  'message.practice_step_3': 'Get feedback',
  'message.practice_step_4': 'Repeat daily',
  'message.profile_intro': 'Update your user and student profile details.',
  'message.profile_photo_intro': 'Upload an image so others can recognize you.',
  'message.quizzes_intro': 'Quick checks after lessons.',
  'message.search_domain_preview': 'Full URL preview:',
  'message.security_intro': 'Change your profile password.',
  'message.sign_out_device': 'Sign out from this device.',
  'message.tests_intro': 'Assignments and unit tests.',
  'message.welcome_user': 'Welcome, {name}',
  'nav.ai_tutor': 'AI Tutor',
  'nav.courses': 'Courses',
  'nav.dashboard': 'Dashboard',
  'nav.downloads': 'Downloads',
  'nav.group.account': 'Account',
  'nav.group.learning': 'Learning',
  'nav.group.tools': 'Tools',
  'nav.lessons': 'Lessons',
  'nav.notebook': 'Think Note',
  'nav.profile': 'Profile',
  'nav.quizzes': 'Quizzes',
  'nav.security': 'Security',
  'nav.tests': 'Tests',
  'org.b2b_tenant': 'B2B Tenant',
  'org.demo': 'Demo',
  'org.marketplace': 'Marketplace',
  'status.available': 'Available',
  'status.cancelled': 'Cancelled',
  'status.completed': 'Completed',
  'status.in_progress': 'In progress',
  'status.locked': 'Locked',
  'status.not_started': 'Not started',
  'status.offline': 'Offline',
  'status.online': 'Online',
  'status.scheduled': 'Scheduled',
  'status.submitted': 'Submitted',
  'placeholder.ai_tutor': 'Ask your AI Tutor...',
  'time.afternoons': 'Afternoons',
  'time.evenings': 'Evenings',
  'time.mornings': 'Mornings',
  'time.select': 'Select time',
  'toast.download_downloading': 'Downloading {lesson}: {item} ({format})',
  'toast.download_opening': 'Opening {lesson}: {item} ({format})',
  'toast.copied': 'Copied',
  'toast.copy_failed': 'Copy failed',
  'toast.dida_started': 'Dida practice started (demo)',
  'toast.enter_valid_domain': 'Enter a valid domain',
  'toast.image_invalid': 'Please select an image file',
  'toast.image_too_large': 'Image must be under 3MB',
  'toast.lesson_started': 'Lesson started',
  'toast.new_chat': 'New chat',
  'toast.no_saved_domain': 'No saved domain found',
  'toast.note_created': 'Note created',
  'toast.note_deleted': 'Note deleted',
  'toast.note_saved': 'Note saved',
  'toast.notifications_off': 'Notifications off',
  'toast.notifications_on': 'Notifications on',
  'toast.opening_lesson': 'Opening lesson',
  'toast.password_length': 'New password must be at least 8 characters',
  'toast.password_mismatch': 'Passwords do not match',
  'toast.password_required': 'Fill out all password fields',
  'toast.password_reset_not_implemented': 'Password reset is not implemented',
  'toast.password_updated': 'Password updated',
  'toast.profile_saved': 'Profile saved',
  'toast.quiz_submitted': 'Quiz submitted',
  'toast.result_not_implemented': 'Result view is not implemented',
  'toast.review_not_implemented': 'Review is not implemented',
  'toast.search': 'Search: {query}',
  'toast.signed_in': 'Signed in',
  'toast.signed_out': 'Signed out',
  'toast.sign_in_missing': 'Enter email and password',
  'toast.switched_org': 'Switched to {org}',
  'toast.test_account_missing': 'Test account is not configured',
  'toast.test_submitted': 'Test submitted',
  'toast.theme_dark': 'Dark mode',
  'toast.theme_light': 'Light mode',
  'ui.course_progress': '{percent}% complete',
  'ui.due': 'Due {date}',
  'ui.format_multiple': 'Formats: {formats}',
  'ui.format_single': 'Format: {formats}',
  'ui.items': 'Items: {count}',
  'ui.not_available': '—',
  'ui.not_set': 'Not set',
  'ui.offline_status': 'Offline: {status}',
  'ui.online_copy_status': 'Online copy: {status}',
  'ui.preview_empty': '---',
  'ui.score': 'Score: {score}',
  'ui.teacher': 'Teacher: {name}',
  'ui.unit_minutes': '{minutes} min',
  'ui.updated': 'Updated {date}',
} as const;

export type MessageKey = keyof typeof EN_MESSAGES;

const RU_MESSAGES: Record<MessageKey, string> = {
  'action.ask_ai_tutor': 'Спросить AI Tutor',
  'action.change': 'Изменить',
  'action.copy': '??????????',
  'action.choose_format': 'Выбрать формат',
  'action.continue': 'Продолжить',
  'action.delete': 'Удалить',
  'action.download': 'Скачать',
  'action.forgot_password': 'Забыли пароль?',
  'action.my_courses': 'Мои курсы',
  'action.new_chat': 'Новый чат',
  'action.new_note': 'Новая заметка',
  'action.open_notebook': 'Открыть заметки',
  'action.open_lessons': 'Уроки',
  'action.open_quizzes': 'Викторины',
  'action.open_tests': 'Тесты',
  'action.remove': 'Удалить',
  'action.review': 'Просмотр',
  'action.save': 'Сохранить',
  'action.save_changes': 'Сохранить изменения',
  'action.send': 'Отправить',
  'action.sign_in': 'Войти',
  'action.sign_out': 'Выйти',
  'action.show_password': '???????? ??????',
  'action.hide_password': '?????? ??????',
  'action.start': 'Начать',
  'action.start_practice': 'Начать практику',
  'action.submit_demo': 'Отправить демо',
  'action.switch_to_b2b': 'Переключиться на B2B Tenant',
  'action.update_password': 'Обновить пароль',
  'action.use_saved_domain': 'Использовать сохраненный домен',
  'action.use_test_account': 'Использовать тестовый аккаунт',
  'action.view_all': 'Посмотреть все',
  'action.view_result': 'Посмотреть результат',
  'app.tagline': 'Студенческий портал',
  'dashboard.courses_in_progress': 'Курсы в процессе',
  'dashboard.lessons_completed': 'Уроки завершены',
  'dashboard.next_up': 'Далее',
  'error.invalid_credentials': 'Неверный email или пароль',
  'error.network': 'Ошибка сети. Проверьте подключение.',
  'error.sign_in_failed': 'Не удалось войти',
  'header.search_placeholder': 'Поиск курсов, уроков...',
  'heading.ai_tutor': 'AI Tutor',
  'heading.change_password': 'Смена пароля',
  'heading.company_domain': 'Домен компании',
  'heading.courses': 'Курсы',
  'heading.dashboard': 'Дашборд',
  'heading.dida': 'Метод Dida',
  'heading.downloads': 'Загрузки',
  'heading.lesson_materials': 'Материалы уроков',
  'heading.login_request_http': '?????? ????? ?? HTTP',
  'heading.lessons': 'Уроки',
  'heading.notebook': 'Заметки',
  'heading.profile': 'Профиль',
  'heading.quizzes': 'Викторины',
  'heading.security': 'Безопасность',
  'heading.session': 'Сессия',
  'heading.student_profile': 'Профиль студента',
  'heading.tests': 'Тесты',
  'heading.user': 'Пользователь',
  'label.bio': 'О себе',
  'label.company_domain': 'Домен компании',
  'label.code': '???',
  'label.confirm_new_password': 'Подтвердите новый пароль',
  'label.content': 'Содержимое',
  'label.course': 'Курс',
  'label.current_password': 'Текущий пароль',
  'label.date': 'Дата',
  'label.date_of_birth': 'Дата рождения',
  'label.domain': 'Домен',
  'label.duration': 'Длительность',
  'label.email': 'Эл. почта',
  'label.url': 'URL',
  'label.request': '??????',
  'label.json': 'JSON',
  'label.http': 'HTTP',
  'label.example': '??????',
  'label.enrollment_date': 'Дата зачисления',
  'label.first_name': 'Имя',
  'label.gender': 'Пол',
  'gender.female': 'Женский',
  'gender.male': 'Мужской',
  'gender.other': 'Другое',
  'label.grade_level': 'Класс',
  'label.language': 'Язык',
  'label.language_preference': 'Язык интерфейса',
  'label.last_name': 'Фамилия',
  'label.lesson': 'Урок',
  'label.notes': 'Заметки',
  'label.offline': 'Офлайн',
  'label.online_copy': 'Онлайн-копия',
  'label.parent_guardian_name': 'Имя родителя/опекуна',
  'label.parent_guardian_phone': 'Телефон родителя/опекуна',
  'label.password': 'Пароль',
  'label.new_password': 'Новый пароль',
  'label.phone': 'Телефон',
  'label.position_title': 'Должность',
  'label.preferred_time': 'Предпочитаемое время',
  'label.profile_photo': 'Фото профиля',
  'label.questions': 'Вопросы',
  'label.quiz': 'Викторина',
  'label.score': 'Балл',
  'label.status': 'Статус',
  'label.title': 'Заголовок',
  'label.tutor': 'Тьютор',
  'label.you': 'Вы',
  'message.ai_tutor_intro': 'Задавайте вопросы и получайте практику (демо, без бэкенда).',
  'message.all_caught_up': 'Все выполнено',
  'message.b2b_only_courses': 'Курсы доступны только для B2B Tenant прямо сейчас.',
  'message.b2b_only_dashboard': 'Учебная панель доступна только для B2B Tenant прямо сейчас.',
  'message.b2b_only_downloads': 'Загрузки доступны только для B2B Tenant прямо сейчас.',
  'message.b2b_only_lessons': 'Уроки доступны только для B2B Tenant прямо сейчас.',
  'message.b2b_only_quizzes': 'Викторины доступны только для B2B Tenant прямо сейчас.',
  'message.b2b_only_tests': 'Тесты доступны только для B2B Tenant прямо сейчас.',
  'message.coming_soon': 'Скоро будет',
  'message.courses_intro': 'Откройте курс, чтобы посмотреть уроки, викторины и тесты.',
  'message.dashboard_continue': 'Продолжайте обучение с того места, где остановились.',
  'message.dida_intro': 'Короткая сфокусированная практика с обратной связью.',
  'message.domain_intro': 'Введите название компании, чтобы перейти на портал.',
  'message.downloads_intro': 'Файлы уроков (PDF, DOCX, ZIP, MP3, MP4).',
  'message.great_work': 'Отличная работа!',
  'message.lesson_materials_intro':
    'Учителя добавляют файлы после занятия. Видео/аудио доступны, когда опубликована онлайн-копия.',
  'message.lessons_intro': 'Офлайн-расписание с онлайн-копиями после занятия.',
  'message.loading_courses': 'Загрузка курсов...',
  'message.loading_dashboard': 'Загрузка дашборда...',
  'message.loading_downloads': 'Загрузка файлов...',
  'message.loading_lessons': 'Загрузка уроков...',
  'message.loading_quizzes': 'Загрузка викторин...',
  'message.loading_tests': 'Загрузка тестов...',
  'message.login_intro':
    'Войдите, чтобы получить доступ к курсам, урокам, викторинам, тестам, загрузкам, заметкам и AI Tutor. Аккаунты создаются администраторами.',
  'message.no_course_selected': 'Курс не выбран',
  'message.no_courses': 'Курсов пока нет',
  'message.no_files': 'Файлов пока нет — скоро.',
  'message.no_note_selected': 'Заметка не выбрана',
  'message.notebook_intro': 'Сохраняйте идеи, ответы и вопросы на потом.',
  'message.practice_step_1': 'Выберите один навык',
  'message.practice_step_2': 'Практикуйтесь 10-15 минут',
  'message.practice_step_3': 'Получите обратную связь',
  'message.practice_step_4': 'Повторяйте ежедневно',
  'message.profile_intro': 'Обновите данные пользователя и студента.',
  'message.profile_photo_intro': 'Загрузите изображение, чтобы вас узнали.',
  'message.quizzes_intro': 'Короткие проверки после уроков.',
  'message.search_domain_preview': 'Предпросмотр URL:',
  'message.security_intro': 'Измените пароль профиля.',
  'message.sign_out_device': 'Выйти с этого устройства.',
  'message.tests_intro': 'Задания и контрольные тесты.',
  'message.welcome_user': 'Добро пожаловать, {name}',
  'nav.ai_tutor': 'AI Tutor',
  'nav.courses': 'Курсы',
  'nav.dashboard': 'Дашборд',
  'nav.downloads': 'Загрузки',
  'nav.group.account': 'Аккаунт',
  'nav.group.learning': 'Обучение',
  'nav.group.tools': 'Инструменты',
  'nav.lessons': 'Уроки',
  'nav.notebook': 'Заметки',
  'nav.profile': 'Профиль',
  'nav.quizzes': 'Викторины',
  'nav.security': 'Безопасность',
  'nav.tests': 'Тесты',
  'org.b2b_tenant': 'B2B Tenant',
  'org.demo': 'Демо',
  'org.marketplace': 'Маркетплейс',
  'status.available': 'Доступно',
  'status.cancelled': 'Отменено',
  'status.completed': 'Завершено',
  'status.in_progress': 'В процессе',
  'status.locked': 'Заблокировано',
  'status.not_started': 'Не начато',
  'status.offline': 'Офлайн',
  'status.online': 'Онлайн',
  'status.scheduled': 'Запланировано',
  'status.submitted': 'Отправлено',
  'placeholder.ai_tutor': 'Спросите AI Tutor...',
  'time.afternoons': 'Днем',
  'time.evenings': 'Вечерами',
  'time.mornings': 'По утрам',
  'time.select': 'Выберите время',
  'toast.download_downloading': 'Скачиваем {lesson}: {item} ({format})',
  'toast.download_opening': 'Открываем {lesson}: {item} ({format})',
  'toast.copy_failed': '?? ??????? ???????????',
  'toast.copied': '???????????',
  'toast.dida_started': 'Практика Dida начата (демо)',
  'toast.enter_valid_domain': 'Введите корректный домен',
  'toast.image_invalid': 'Выберите файл изображения',
  'toast.image_too_large': 'Изображение должно быть до 3MB',
  'toast.lesson_started': 'Урок начат',
  'toast.new_chat': 'Новый чат',
  'toast.no_saved_domain': 'Сохраненный домен не найден',
  'toast.note_created': 'Заметка создана',
  'toast.note_deleted': 'Заметка удалена',
  'toast.note_saved': 'Заметка сохранена',
  'toast.notifications_off': 'Уведомления выключены',
  'toast.notifications_on': 'Уведомления включены',
  'toast.opening_lesson': 'Открытие урока',
  'toast.password_length': 'Новый пароль должен быть минимум 8 символов',
  'toast.password_mismatch': 'Пароли не совпадают',
  'toast.password_required': 'Заполните все поля пароля',
  'toast.password_reset_not_implemented': 'Сброс пароля не реализован',
  'toast.password_updated': 'Пароль обновлен',
  'toast.profile_saved': 'Профиль сохранен',
  'toast.quiz_submitted': 'Викторина отправлена',
  'toast.result_not_implemented': 'Просмотр результата не реализован',
  'toast.review_not_implemented': 'Просмотр не реализован',
  'toast.search': 'Поиск: {query}',
  'toast.signed_in': 'Вход выполнен',
  'toast.signed_out': 'Вы вышли',
  'toast.sign_in_missing': 'Введите эл. почту и пароль',
  'toast.switched_org': 'Переключено на {org}',
  'toast.test_account_missing': 'Тестовый аккаунт не настроен',
  'toast.test_submitted': 'Тест отправлен',
  'toast.theme_dark': 'Темная тема',
  'toast.theme_light': 'Светлая тема',
  'ui.course_progress': '{percent}% завершено',
  'ui.due': 'Сдать до {date}',
  'ui.format_multiple': 'Форматы: {formats}',
  'ui.format_single': 'Формат: {formats}',
  'ui.items': 'Элементов: {count}',
  'ui.not_available': '—',
  'ui.not_set': 'Не задано',
  'ui.offline_status': 'Офлайн: {status}',
  'ui.online_copy_status': 'Онлайн-копия: {status}',
  'ui.preview_empty': '---',
  'ui.score': 'Балл: {score}',
  'ui.teacher': 'Преподаватель: {name}',
  'ui.unit_minutes': '{minutes} мин',
  'ui.updated': 'Обновлено {date}',
};

const TJ_MESSAGES: Record<MessageKey, string> = {
  'action.ask_ai_tutor': 'Аз Ёвари AI пурсед',
  'action.change': 'Тағйир',
  'action.copy': '????? ?????????',
  'action.choose_format': 'Интихоби формат',
  'action.continue': 'Идома',
  'action.delete': 'Ҳазф кардан',
  'action.download': 'Зеркашӣ',
  'action.forgot_password': 'Паролро фаромӯш кардед?',
  'action.my_courses': 'Курсҳои ман',
  'action.new_chat': 'Чати нав',
  'action.new_note': 'Ёддошти нав',
  'action.open_notebook': 'Кушодани ёддоштҳо',
  'action.open_lessons': 'Дарсҳо',
  'action.open_quizzes': 'Викторинаҳо',
  'action.open_tests': 'Санҷишҳо',
  'action.remove': 'Ҳазф',
  'action.review': 'Баррасӣ',
  'action.save': 'Захира кардан',
  'action.save_changes': 'Захира кардани тағйирот',
  'action.send': 'Фиристодан',
  'action.sign_in': 'Вуруд',
  'action.sign_out': 'Баромадан',
  'action.show_password': '????? ?????? ????',
  'action.hide_password': '?????? ??????? ????',
  'action.start': 'Оғоз',
  'action.start_practice': 'Оғози машқ',
  'action.submit_demo': 'Фиристодани демо',
  'action.switch_to_b2b': 'Гузариш ба B2B Tenant',
  'action.update_password': 'Навсозии парол',
  'action.use_saved_domain': 'Истифодаи домени захирашуда',
  'action.use_test_account': 'Истифодаи ҳисоби санҷишӣ',
  'action.view_all': 'Ҳамаро дидан',
  'action.view_result': 'Натиҷаро дидан',
  'app.tagline': 'Портали донишҷӯ',
  'dashboard.courses_in_progress': 'Курсҳои ҷараёнӣ',
  'dashboard.lessons_completed': 'Дарсҳо анҷом ёфтанд',
  'dashboard.next_up': 'Баъдан',
  'error.invalid_credentials': 'Э-почта ё парол нодуруст аст',
  'error.network': 'Хатои шабака. Пайвастшавиро санҷед.',
  'error.sign_in_failed': 'Ворид шудан нашуд',
  'header.search_placeholder': 'Ҷустуҷӯи курсҳо, дарсҳо...',
  'heading.ai_tutor': 'AI Tutor',
  'heading.change_password': 'Иваз кардани парол',
  'heading.company_domain': 'Домени ширкат',
  'heading.courses': 'Курсҳо',
  'heading.dashboard': 'Панел',
  'heading.dida': 'Усули Dida',
  'heading.downloads': 'Зеркашиҳо',
  'heading.lesson_materials': 'Маводҳои дарс',
  'heading.login_request_http': '???????? ????????? ????????? HTTP',
  'heading.lessons': 'Дарсҳо',
  'heading.notebook': 'Ёддоштҳо',
  'heading.profile': 'Профил',
  'heading.quizzes': 'Викторинаҳо',
  'heading.security': 'Амният',
  'heading.session': 'Ҷаласа',
  'heading.student_profile': 'Профили донишҷӯ',
  'heading.tests': 'Санҷишҳо',
  'heading.user': 'Истифодабаранда',
  'label.bio': 'Дар бораи худ',
  'label.company_domain': 'Домени ширкат',
  'label.code': '???',
  'label.confirm_new_password': 'Тасдиқи пароли нав',
  'label.content': 'Мундариҷа',
  'label.course': 'Курс',
  'label.current_password': 'Пароли ҷорӣ',
  'label.date': 'Сана',
  'label.date_of_birth': 'Санаи таваллуд',
  'label.domain': 'Домейн',
  'label.duration': 'Давомнокӣ',
  'label.email': 'Э-почта',
  'label.url': 'URL',
  'label.request': '???????',
  'label.json': 'JSON',
  'label.http': 'HTTP',
  'label.example': '?????',
  'label.enrollment_date': 'Санаи қабул',
  'label.first_name': 'Ном',
  'label.gender': 'Ҷинс',
  'gender.female': 'Зан',
  'gender.male': 'Мард',
  'gender.other': 'Дигар',
  'label.grade_level': 'Синф',
  'label.language': 'Забон',
  'label.language_preference': 'Забони интерфейс',
  'label.last_name': 'Насаб',
  'label.lesson': 'Дарс',
  'label.notes': 'Ёддоштҳо',
  'label.offline': 'Офлайн',
  'label.online_copy': 'Нусхаи онлайн',
  'label.parent_guardian_name': 'Номи волидайн/сарпараст',
  'label.parent_guardian_phone': 'Телефони волидайн/сарпараст',
  'label.password': 'Парол',
  'label.new_password': 'Пароли нав',
  'label.phone': 'Телефон',
  'label.position_title': 'Вазифа',
  'label.preferred_time': 'Вақти афзал',
  'label.profile_photo': 'Акс барои профил',
  'label.questions': 'Саволҳо',
  'label.quiz': 'Викторина',
  'label.score': 'Хол',
  'label.status': 'Ҳолат',
  'label.title': 'Сарлавҳа',
  'label.tutor': 'Тьютор',
  'label.you': 'Шумо',
  'message.ai_tutor_intro': 'Савол диҳед ва машқ гиред (демо, бе сервер).',
  'message.all_caught_up': 'Ҳама иҷро шуд',
  'message.b2b_only_courses': 'Курсҳо ҳоло танҳо барои B2B Tenant дастрасанд.',
  'message.b2b_only_dashboard': 'Панели омӯзишӣ ҳоло танҳо барои B2B Tenant дастрас аст.',
  'message.b2b_only_downloads': 'Зеркашиҳо ҳоло танҳо барои B2B Tenant дастрасанд.',
  'message.b2b_only_lessons': 'Дарсҳо ҳоло танҳо барои B2B Tenant дастрасанд.',
  'message.b2b_only_quizzes': 'Викторинаҳо ҳоло танҳо барои B2B Tenant дастрасанд.',
  'message.b2b_only_tests': 'Санҷишҳо ҳоло танҳо барои B2B Tenant дастрасанд.',
  'message.coming_soon': 'Ба зудӣ',
  'message.courses_intro': 'Курсро кушоед, то дарсҳо, викторинаҳо ва санҷишҳоро бинед.',
  'message.dashboard_continue': 'Омӯзишро аз ҷое, ки қатъ кардед, идома диҳед.',
  'message.dida_intro': 'Машқи кӯтоҳу равона бо бозхӯр.',
  'message.domain_intro': 'Номи ширкатро ворид кунед, то ба портал гузаред.',
  'message.downloads_intro': 'Файлҳои дарс (PDF, DOCX, ZIP, MP3, MP4).',
  'message.great_work': 'Офарин!',
  'message.lesson_materials_intro':
    'Муаллимон баъди дарс файлҳоро илова мекунанд. Видео/аудио ҳангоми нашри нусхаи онлайн дастрас мешаванд.',
  'message.lessons_intro': 'Ҷадвали офлайн бо нусхаҳои онлайн баъди дарс.',
  'message.loading_courses': 'Курсҳо бор шуда истодаанд...',
  'message.loading_dashboard': 'Панел бор шуда истодааст...',
  'message.loading_downloads': 'Зеркашиҳо бор шуда истодаанд...',
  'message.loading_lessons': 'Дарсҳо бор шуда истодаанд...',
  'message.loading_quizzes': 'Викторинаҳо бор шуда истодаанд...',
  'message.loading_tests': 'Санҷишҳо бор шуда истодаанд...',
  'message.login_intro':
    'Барои дастрасӣ ба курсҳо, дарсҳо, викторинаҳо, санҷишҳо, зеркашиҳо, ёддоштҳо ва ёвари AI ворид шавед. Ҳисобҳо аз ҷониби маъмурон дода мешаванд.',
  'message.no_course_selected': 'Курс интихоб нашудааст',
  'message.no_courses': 'Ҳоло курс нест',
  'message.no_files': 'Ҳоло файл нест — ба зудӣ.',
  'message.no_note_selected': 'Ёддошт интихоб нашудааст',
  'message.notebook_intro': 'Идеяҳо, ҷавобҳо ва саволҳоро барои баъд нигоҳ доред.',
  'message.practice_step_1': 'Як малака интихоб кунед',
  'message.practice_step_2': '10-15 дақиқа машқ кунед',
  'message.practice_step_3': 'Бозхӯр гиред',
  'message.practice_step_4': 'Ҳар рӯз такрор кунед',
  'message.profile_intro': 'Маълумоти корбар ва донишҷӯро нав кунед.',
  'message.profile_photo_intro': 'Аксеро бор кунед, то дигарон шуморо шиносанд.',
  'message.quizzes_intro': 'Санҷишҳои кӯтоҳ баъди дарсҳо.',
  'message.search_domain_preview': 'Намоиши URL:',
  'message.security_intro': 'Пароли профилро иваз кунед.',
  'message.sign_out_device': 'Аз ин дастгоҳ бароед.',
  'message.tests_intro': 'Супоришҳо ва санҷишҳои воҳид.',
  'message.welcome_user': 'Хуш омадед, {name}',
  'nav.ai_tutor': 'AI Tutor',
  'nav.courses': 'Курсҳо',
  'nav.dashboard': 'Панел',
  'nav.downloads': 'Зеркашиҳо',
  'nav.group.account': 'Ҳисоб',
  'nav.group.learning': 'Омӯзиш',
  'nav.group.tools': 'Асбобҳо',
  'nav.lessons': 'Дарсҳо',
  'nav.notebook': 'Ёддоштҳо',
  'nav.profile': 'Профил',
  'nav.quizzes': 'Викторинаҳо',
  'nav.security': 'Амният',
  'nav.tests': 'Санҷишҳо',
  'org.b2b_tenant': 'B2B Tenant',
  'org.demo': 'Демо',
  'org.marketplace': 'Маркетплейс',
  'status.available': 'Дастрас',
  'status.cancelled': 'Бекор шуд',
  'status.completed': 'Ба анҷом расид',
  'status.in_progress': 'Дар раванди иҷро',
  'status.locked': 'Қулф шудааст',
  'status.not_started': 'Оғоз нашудааст',
  'status.offline': 'Офлайн',
  'status.online': 'Онлайн',
  'status.scheduled': 'Нақша шудааст',
  'status.submitted': 'Супорида шуд',
  'placeholder.ai_tutor': 'Аз Ёвари AI пурсед...',
  'time.afternoons': 'Нимаи рӯз',
  'time.evenings': 'Шомҳо',
  'time.mornings': 'Субҳҳо',
  'time.select': 'Вақт интихоб кунед',
  'toast.download_downloading': 'Зеркашӣ {lesson}: {item} ({format})',
  'toast.download_opening': 'Кушодан {lesson}: {item} ({format})',
  'toast.copy_failed': '???????????? ?????',
  'toast.copied': '????? ???',
  'toast.dida_started': 'Машқи Dida оғоз шуд (демо)',
  'toast.enter_valid_domain': 'Домени дуруст ворид кунед',
  'toast.image_invalid': 'Файли тасвирро интихоб кунед',
  'toast.image_too_large': 'Акс бояд то 3MB бошад',
  'toast.lesson_started': 'Дарс оғоз шуд',
  'toast.new_chat': 'Чати нав',
  'toast.no_saved_domain': 'Домени захирашуда ёфт нашуд',
  'toast.note_created': 'Ёддошт сохта шуд',
  'toast.note_deleted': 'Ёддошт ҳазф шуд',
  'toast.note_saved': 'Ёддошт захира шуд',
  'toast.notifications_off': 'Огоҳӣ хомӯш',
  'toast.notifications_on': 'Огоҳӣ фаъол',
  'toast.opening_lesson': 'Кушодани дарс',
  'toast.password_length': 'Пароли нав бояд ҳадди ақал 8 аломат бошад',
  'toast.password_mismatch': 'Паролҳо мувофиқ нестанд',
  'toast.password_required': 'Ҳама майдонҳои паролро пур кунед',
  'toast.password_reset_not_implemented': 'Барқароркунии парол иҷро нашудааст',
  'toast.password_updated': 'Парол нав шуд',
  'toast.profile_saved': 'Профил захира шуд',
  'toast.quiz_submitted': 'Викторина фиристода шуд',
  'toast.result_not_implemented': 'Намоиши натиҷа иҷро нашудааст',
  'toast.review_not_implemented': 'Баррасӣ иҷро нашудааст',
  'toast.search': 'Ҷустуҷӯ: {query}',
  'toast.signed_in': 'Ворид шудед',
  'toast.signed_out': 'Шумо баромадед',
  'toast.sign_in_missing': 'Э-почта ва паролро ворид кунед',
  'toast.switched_org': 'Гузариш ба {org}',
  'toast.test_account_missing': 'Ҳисоби санҷишӣ танзим нашудааст',
  'toast.test_submitted': 'Санҷиш фиристода шуд',
  'toast.theme_dark': 'Режими торик',
  'toast.theme_light': 'Режими равшан',
  'ui.course_progress': '{percent}% анҷом ёфт',
  'ui.due': 'Мӯҳлат {date}',
  'ui.format_multiple': 'Форматҳо: {formats}',
  'ui.format_single': 'Формат: {formats}',
  'ui.items': 'Маводҳо: {count}',
  'ui.not_available': '—',
  'ui.not_set': 'Номуайян',
  'ui.offline_status': 'Офлайн: {status}',
  'ui.online_copy_status': 'Нусхаи онлайн: {status}',
  'ui.preview_empty': '---',
  'ui.score': 'Хол: {score}',
  'ui.teacher': 'Муаллим: {name}',
  'ui.unit_minutes': '{minutes} дақ',
  'ui.updated': 'Навсозӣ {date}',
};

const MESSAGES: Record<Locale, Record<MessageKey, string>> = {
  en: EN_MESSAGES,
  ru: RU_MESSAGES,
  tj: TJ_MESSAGES,
};

function isLocale(value: string | null): value is Locale {
  return Boolean(value && SUPPORTED_LOCALES.includes(value as Locale));
}

function loadLocale(): Locale {
  try {
    const raw = window.localStorage.getItem(STORAGE_KEY);
    if (isLocale(raw)) return raw;
  } catch {
    // ignore
  }
  return 'en';
}

function saveLocale(locale: Locale) {
  try {
    window.localStorage.setItem(STORAGE_KEY, locale);
  } catch {
    // ignore
  }
}

function applyLocale(locale: Locale) {
  document.documentElement.lang = locale;
}

function formatMessage(template: string, params?: Record<string, string | number>) {
  if (!params) return template;
  return template.replace(/\{(\w+)\}/g, (match, token) => {
    const value = params[token];
    return value === undefined ? match : String(value);
  });
}

@Injectable({ providedIn: 'root' })
export class I18nStore {
  readonly locale = signal<Locale>(loadLocale());
  readonly languageOptions = [
    { id: 'en', label: 'EN' },
    { id: 'ru', label: 'RUS' },
    { id: 'tj', label: 'TJK' },
  ] as const;

  constructor() {
    applyLocale(this.locale());
  }

  setLocale(locale: Locale) {
    if (this.locale() === locale) return;
    this.locale.set(locale);
    saveLocale(locale);
    applyLocale(locale);
  }

  t(key: MessageKey, params?: Record<string, string | number>): string;
  t(key: string, params?: Record<string, string | number>): string;
  t(key: string, params?: Record<string, string | number>) {
    const messages = MESSAGES[this.locale()] as Record<string, string>;
    const fallback = EN_MESSAGES as Record<string, string>;
    const template = messages[key] ?? fallback[key] ?? key;
    return formatMessage(template, params);
  }
}

export function isSupportedLocale(value: string | null): value is Locale {
  return isLocale(value);
}
